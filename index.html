<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My 2025 Journal</title>
  <style>
    :root {
      --primary: #5a3a22;
      --secondary: #794f30;
      --paper: #fffaf0;
      --bg: #f0e8d9;
      --text: #333;
      --border-color: #ddd;
    }
    [data-theme="dark"] {
      --primary: #e6d3c1;
      --secondary: #c3b3a5;
      --paper: #1c1c1c;
      --bg: #121212;
      --text: #e2e2e2;
      --border-color: #444;
    }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: Georgia, serif; display: flex; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; min-height: 100vh; transition: background 0.3s, color 0.3s; }
    .journal-page { width: 100%; max-width: 600px; background: var(--paper); padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; box-sizing: border-box; transition: background 0.3s; }
    .date-header { font-family: 'Courier New', monospace; font-size: 1.2em; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin: 0 0 20px 0; }
    textarea { width: 100%; font-size: 1em; font-family: Georgia, serif; border: 1px solid var(--border-color); background: transparent; resize: none; outline: none; line-height: 1.6; color: var(--text); box-sizing: border-box; border-radius: 6px; padding: 8px; min-height: 3em; overflow-y: hidden; }
    textarea:focus { border-color: var(--secondary); box-shadow: 0 0 5px var(--secondary); }
    .page-number { margin-top: 20px; font-size: 0.9em; text-align: right; color: #888; }
    .controls { margin-top: 20px; display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; }
    button { background: var(--primary); color: white; border: none; padding: 10px 20px; font-size: 1em; border-radius: 5px; cursor: pointer; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); transition: background 0.3s; }
    button:hover:not(:disabled) { background: var(--secondary); }
    button:disabled { background: #a99484; cursor: not-allowed; }
    select { width: 100%; padding: 8px; font-size: 1em; margin-top: 4px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--paper); color: var(--text); }
    .theme-toggle { position: fixed; top: 10px; right: 10px; font-size: 0.9em; z-index: 10; }
    blockquote { margin: 0 0 20px; padding: 15px; background-color: rgba(0,0,0,0.03); border-left: 4px solid var(--secondary); font-style: italic; }
    [data-theme="dark"] blockquote { background-color: rgba(255,255,255,0.05); }

    /* --- UI STRUCTURE STYLES --- */
    fieldset {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px 15px 15px;
      margin-bottom: 20px;
    }
    legend {
      font-weight: bold;
      font-size: 1.1em;
      padding: 0 10px;
      color: var(--primary);
    }
    label { display: block; margin-top: 10px; font-weight: bold; margin-bottom: 5px; }
    .habits-section label, .moods-section label { font-weight: normal; display: flex; align-items: center; gap: 8px; margin-top: 8px; }
    
    /* --- TABLE STYLES --- */
    #dailyScheduleTable { width: 100%; border-collapse: collapse; margin-top: 8px; }
    #dailyScheduleTable td { border: 1px solid var(--border-color); padding: 8px; vertical-align: top; }
    #dailyScheduleTable td:first-child { width: 35%; font-weight: bold; }
    #dailyScheduleTable td[contenteditable="true"] { outline: none; }
    #dailyScheduleTable td[contenteditable="true"]:focus { background: rgba(255, 215, 0, 0.2); box-shadow: inset 0 0 5px var(--secondary); }
    #dailyScheduleTable td[contenteditable="true"]:empty::before { content: '...'; color: #999; font-style: italic; }

    @media (max-width: 500px) {
      textarea, #dailyScheduleTable td, select { font-size: 0.9em; }
      button { font-size: 0.9em; padding: 8px 12px; }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle">🌙 Dark Mode</button>
  <div class="journal-page">
    <h2 class="date-header" id="dateHeader">Loading...</h2>
    <blockquote id="quoteBox">"Quote of the day"</blockquote>

    <!-- REORDERED AND GROUPED UI -->
    <fieldset>
      <legend>☀️ Morning Intentions</legend>
      <label for="affirmation">📝 My Affirmation for Today:</label>
      <textarea id="affirmation" rows="2"></textarea>
      
      <label for="gratitude">🙏 Today, I Am Grateful For:</label>
      <textarea id="gratitude" rows="2"></textarea>
      
      <label for="topTasks">🔥 My Top 3 Priorities:</label>
      <textarea id="topTasks" rows="3" placeholder="1. ...
2. ...
3. ..."></textarea>

      <label>🗓️ My Daily Schedule:</label>
      <table id="dailyScheduleTable">
        <tbody>
          <tr><td contenteditable="true" data-slot="time-1">6am-9am</td><td contenteditable="true" data-slot="activity-1"></td></tr>
          <tr><td contenteditable="true" data-slot="time-2">9am-12pm</td><td contenteditable="true" data-slot="activity-2"></td></tr>
          <tr><td contenteditable="true" data-slot="time-3">12pm-2pm</td><td contenteditable="true" data-slot="activity-3"></td></tr>
          <tr><td contenteditable="true" data-slot="time-4">2pm-5pm</td><td contenteditable="true" data-slot="activity-4"></td></tr>
          <tr><td contenteditable="true" data-slot="time-5">5pm-9pm</td><td contenteditable="true" data-slot="activity-5"></td></tr>
          <tr><td contenteditable="true" data-slot="time-6">9pm onwards</td><td contenteditable="true" data-slot="activity-6"></td></tr>
        </tbody>
      </table>
    </fieldset>

    <fieldset>
      <legend>📊 Daily Log</legend>
      <div class="moods-section">
        <label>Mood Tracker:</label>
        <select id="moodMorning"><option value="">🌅 Morning</option><option>😊 Happy</option><option>😐 Meh</option><option>😴 Tired</option><option>😔 Sad</option><option>😡 Stressed</option></select>
        <select id="moodAfternoon"><option value="">🏞 Afternoon</option><option>😊 Happy</option><option>😐 Meh</option><option>😴 Tired</option><option>😔 Sad</option><option>😡 Stressed</option></select>
        <select id="moodEvening"><option value="">🌙 Evening</option><option>😊 Happy</option><option>😐 Meh</option><option>😴 Tired</option><option>😔 Sad</option><option>😡 Stressed</option></select>
      </div>
      <div class="habits-section">
        <label>Habit Tracker:</label>
        <label><input type="checkbox" id="habitRead"> 📚 Read 10 min</label>
        <label><input type="checkbox" id="habitMove"> 🚶 20‑min Walk</label>
        <label><input type="checkbox" id="habitWater"> 💧 2 L Water</label>
      </div>
    </fieldset>

    <fieldset>
      <legend>🌙 Evening Review</legend>
      <label for="eveningReflection">My Reflection on Today:</label>
      <textarea id="eveningReflection" rows="4" placeholder="How was today? What did I learn? What went well?"></textarea>
      
      <label for="entryBox">Main Journal Entry:</label>
      <textarea id="entryBox" rows="8" placeholder="Write freely..."></textarea>
    </fieldset>

    <div class="page-number" id="pageNumber"></div>
  </div>

  <div class="controls">
    <button id="prevBtn">‹ Prev</button>
    <button id="nextBtn">Next ›</button>
  </div>
  <div class="controls">
    <button id="downloadBackup">⬇️ Backup</button>
    <input type="file" id="uploadBackup" accept=".json" style="display:none;">
    <button id="loadBackup">⬆️ Load Backup</button>
  </div>
  <p style="font-size: 0.8em; color: #888; text-align: center; max-width: 600px;">Your journal is saved in this browser. Please use <strong>Backup</strong> regularly.</p>
  
  <script>
    // --- REFACTORED JAVASCRIPT ---
    const app = {
      YEAR: 2025,
      TOTAL_DAYS: 0,
      currentDay: 1,
      dom: {}, // To store DOM elements
      config: {}, // To store field configurations
      
      // 1. INITIALIZATION
      init() {
        this.TOTAL_DAYS = ((this.YEAR % 4 === 0 && this.YEAR % 100 !== 0) || (this.YEAR % 400 === 0)) ? 366 : 365;
        this.cacheDom();
        this.initConfig();
        this.bindEvents();
        this.loadInitialPage();
        this.loadTheme();
      },
      
      // 2. CACHE DOM ELEMENTS
      cacheDom() {
        this.dom.dateHeader = document.getElementById('dateHeader');
        this.dom.pageNumber = document.getElementById('pageNumber');
        this.dom.quoteBox = document.getElementById('quoteBox');
        this.dom.prevBtn = document.getElementById('prevBtn');
        this.dom.nextBtn = document.getElementById('nextBtn');
        this.dom.themeToggle = document.getElementById('themeToggle');
        this.dom.downloadBtn = document.getElementById('downloadBackup');
        this.dom.uploadBtn = document.getElementById('uploadBackup');
        this.dom.loadBtn = document.getElementById('loadBackup');
        // All journal fields are accessed via config
      },
      
      // 3. CONFIGURE JOURNAL FIELDS
      initConfig() {
          this.config = {
              affirmation: { type: 'textarea', el: document.getElementById('affirmation') },
              gratitude: { type: 'textarea', el: document.getElementById('gratitude') },
              topTasks: { type: 'textarea', el: document.getElementById('topTasks') },
              eveningReflection: { type: 'textarea', el: document.getElementById('eveningReflection') },
              entryBox: { type: 'textarea', el: document.getElementById('entryBox') },
              moodMorning: { type: 'value', el: document.getElementById('moodMorning') },
              moodAfternoon: { type: 'value', el: document.getElementById('moodAfternoon') },
              moodEvening: { type: 'value', el: document.getElementById('moodEvening') },
              habitRead: { type: 'checked', el: document.getElementById('habitRead') },
              habitMove: { type: 'checked', el: document.getElementById('habitMove') },
              habitWater: { type: 'checked', el: document.getElementById('habitWater') },
              schedule: {
                  type: 'table',
                  el: document.getElementById('dailyScheduleTable'),
                  // Custom save/load for the table
                  save: (el) => {
                      const data = [];
                      el.querySelectorAll('tbody tr').forEach(row => {
                          data.push({
                              time: row.cells[0].innerText,
                              activity: row.cells[1].innerHTML
                          });
                      });
                      return JSON.stringify(data);
                  },
                  load: (el, value) => {
                      try {
                          const data = value ? JSON.parse(value) : [];
                          const rows = el.querySelectorAll('tbody tr');
                          rows.forEach((row, i) => {
                              row.cells[0].innerText = data[i]?.time || row.cells[0].innerText;
                              row.cells[1].innerHTML = data[i]?.activity || '';
                          });
                      } catch (e) {
                          console.error("Failed to parse schedule JSON", e);
                      }
                  }
              }
          };
      },
      
      // 4. BIND EVENT LISTENERS
      bindEvents() {
        this.dom.prevBtn.addEventListener('click', () => this.navigate(-1));
        this.dom.nextBtn.addEventListener('click', () => this.navigate(1));
        this.dom.themeToggle.addEventListener('click', () => this.toggleTheme());
        this.dom.downloadBtn.addEventListener('click', () => this.downloadBackup());
        this.dom.loadBtn.addEventListener('click', () => this.dom.uploadBtn.click());
        this.dom.uploadBtn.addEventListener('change', (e) => this.loadBackup(e));
        
        // Auto-save for all configured fields
        Object.values(this.config).forEach(field => {
            field.el.addEventListener('input', () => this.saveState());
        });

        // Auto-grow for textareas
        document.querySelectorAll('textarea').forEach(el => {
            el.addEventListener('input', () => this.autoGrow(el));
        });
      },
      
      // 5. CORE LOGIC
      getStorageKey(day, key) { return `journal-${this.YEAR}-day-${day}-${key}`; },
      
      saveState() {
        try {
          for (const [key, field] of Object.entries(this.config)) {
            const value = field.save ? field.save(field.el) : field.el[field.type];
            localStorage.setItem(this.getStorageKey(this.currentDay, key), value);
          }
          localStorage.setItem('journal-last-opened', this.currentDay);
        } catch (e) {
          console.error("Failed to save state to localStorage.", e);
          alert("Error saving data. Your browser's storage might be full or disabled.");
        }
      },
      
      loadState() {
        for (const [key, field] of Object.entries(this.config)) {
          const value = localStorage.getItem(this.getStorageKey(this.currentDay, key));
          if (field.load) {
            field.load(field.el, value);
          } else if (value !== null) {
            field.el[field.type] = field.type === 'checked' ? value === 'true' : value;
          } else {
            // Reset to default
            field.el[field.type] = field.type === 'checked' ? false : '';
          }
        }
      },
      
      updatePage() {
        const date = new Date(this.YEAR, 0, this.currentDay);
        this.dom.dateHeader.textContent = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        this.dom.pageNumber.textContent = `Day ${this.currentDay} of ${this.TOTAL_DAYS}`;
        this.dom.quoteBox.textContent = this.getQuote();
        
        this.loadState();
        
        document.querySelectorAll('textarea').forEach(this.autoGrow);
        this.dom.prevBtn.disabled = this.currentDay <= 1;
        this.dom.nextBtn.disabled = this.currentDay >= this.TOTAL_DAYS;
      },
      
      navigate(direction) {
        this.saveState();
        const newDay = this.currentDay + direction;
        if (newDay >= 1 && newDay <= this.TOTAL_DAYS) {
          this.currentDay = newDay;
          this.updatePage();
        }
      },
      
      loadInitialPage() {
        const saved = parseInt(localStorage.getItem('journal-last-opened'), 10);
        const today = new Date();
        const start = new Date(this.YEAR, 0, 1);
        const dayOfYear = Math.floor((today - start) / (1000 * 60 * 60 * 24)) + 1;
        this.currentDay = !isNaN(saved) ? saved : (today.getFullYear() === this.YEAR ? dayOfYear : 1);
        this.updatePage();
      },

      // 6. HELPER FUNCTIONS
      autoGrow(element) {
        element.style.height = 'auto';
        element.style.height = (element.scrollHeight) + 'px';
      },
      
      getQuote() {
          const QUOTES = [ "The journey of a thousand miles begins with a single step. — Lao Tzu", "The secret of getting ahead is getting started. — Mark Twain", "The best time to plant a tree was 20 years ago. The second best time is now. — Chinese Proverb", "It does not matter how slowly you go as long as you do not stop. — Confucius", "Believe you can and you're halfway there. — Theodore Roosevelt", "Act as if what you do makes a difference. It does. — William James", "Success is not final, failure is not fatal: it is the courage to continue that counts. — Winston Churchill", "What you do today can improve all your tomorrows. — Ralph Marston", "Focus on being productive instead of busy. — Tim Ferriss", "Discipline is the bridge between goals and accomplishment. — Jim Rohn", "The key is not to prioritize what's on your schedule, but to schedule your priorities. — Stephen Covey", "Either you run the day or the day runs you. — Jim Rohn", "We are what we repeatedly do. Excellence, then, is not an act, but a habit. — Aristotle", "The best way to predict the future is to create it. — Peter Drucker", "An unexamined life is not worth living. — Socrates", "Done is better than good. — Elizabeth Gilbert", /* Add more quotes */ ];
          return QUOTES[(this.currentDay - 1) % QUOTES.length];
      },
      
      // 7. THEME AND BACKUP
      toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        if (currentTheme === 'dark') {
          document.documentElement.removeAttribute('data-theme');
          localStorage.setItem('journal-theme', 'light');
          this.dom.themeToggle.textContent = '🌙 Dark Mode';
        } else {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('journal-theme', 'dark');
          this.dom.themeToggle.textContent = '☀️ Light Mode';
        }
      },
      
      loadTheme() {
        if (localStorage.getItem('journal-theme') === 'dark') {
          this.toggleTheme(); // Call toggle to set it correctly
        }
      },

      downloadBackup() {
        const data = {};
        for (let day = 1; day <= this.TOTAL_DAYS; day++) {
          const dayData = {};
          let hasData = false;
          for (const key of Object.keys(this.config)) {
            const value = localStorage.getItem(this.getStorageKey(day, key));
            if (value) {
              dayData[key] = value;
              hasData = true;
            }
          }
          if (hasData) {
            data[`day-${day}`] = dayData;
          }
        }
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `journal-backup-${this.YEAR}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      },
      
      loadBackup(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            if(confirm('This will overwrite existing data in your browser. Are you sure?')) {
              for (const [dayKey, values] of Object.entries(data)) {
                const day = parseInt(dayKey.replace('day-', ''), 10);
                if (day >= 1 && day <= this.TOTAL_DAYS) {
                  for (const [fieldKey, fieldValue] of Object.entries(values)) {
                    localStorage.setItem(this.getStorageKey(day, fieldKey), fieldValue);
                  }
                }
              }
              alert('✅ Backup loaded successfully!');
              this.updatePage();
            }
          } catch (err) {
            alert('❌ Failed to load backup. Invalid file.');
            console.error(err);
          }
        };
        reader.readAsText(file);
        e.target.value = ''; // Reset file input
      }
    };
    
    // Start the application
    app.init();
  </script>
</body>
</html>
