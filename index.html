<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Action Journal</title>
  <style>
    :root {
      --primary: #2d5a6b;
      --secondary: #4a8296;
      --paper: #f5f5f5;
      --bg: #e4e9ed;
      --text: #333;
      --border-color: #ccc;
      --label-color: #555;
    }
    [data-theme="dark"] {
      --primary: #88c0d0;
      --secondary: #5e81ac;
      --paper: #2e3440;
      --bg: #21252b;
      --text: #d8dee9;
      --border-color: #4c566a;
      --label-color: #a0a0a0;
    }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; min-height: 100vh; transition: background 0.3s, color 0.3s; }
    main { width: 100%; max-width: 600px; background: var(--paper); padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 25px; }
    header { text-align: center; }
    .date-header { font-family: 'Courier New', monospace; font-size: 1.2em; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin: 0; }
    
    h2 { font-size: 1.3em; margin: 0 0 15px 0; padding-bottom: 5px; border-bottom: 2px solid var(--primary); color: var(--primary); }
    
    /* NEW: Input Group for Labels and Textareas */
    .input-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
    .input-group label { font-weight: bold; color: var(--label-color); font-size: 1em; }

    textarea {
      width: 100%;
      box-sizing: border-box;
      font-size: 1.1em;
      line-height: 1.6;
      font-family: inherit;
      border: 1px solid var(--border-color); /* Subtle border for clarity */
      border-radius: 4px;
      background: transparent;
      resize: none;
      outline: none;
      color: var(--text);
      padding: 8px;
      overflow-y: hidden;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary) 20%, transparent); }

    footer { font-size: 0.9em; text-align: right; color: #888; margin-top: 10px; }
    .controls { margin-top: 20px; display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; }
    button { background: var(--primary); color: white; border: none; padding: 10px 20px; font-size: 1em; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
    button:hover:not(:disabled) { background: var(--secondary); }
    button:disabled { background: #a99484; cursor: not-allowed; }
    .theme-toggle { position: fixed; top: 10px; right: 10px; font-size: 0.9em; z-index: 10; }

    /* Compact Trackers */
    .trackers { display: flex; justify-content: space-around; background: color-mix(in srgb, var(--bg) 50%, var(--paper)); padding: 15px; border-radius: 8px; }
    .tracker-group { display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .tracker-group label { font-weight: bold; font-size: 0.9em; }
    .tracker-group select { font-size: 0.9em; }
    
    /* NEW: Better Habit Tracker Styling */
    .habit-list { display: flex; gap: 15px; align-items: center; }
    .habit { display: flex; align-items: center; gap: 5px; cursor: pointer;}
    .habit label { cursor: pointer; font-weight: normal; }

  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle">üåô</button>
  
  <main class="journal-page">
    <header>
      <h1 class="date-header" id="dateHeader">Loading...</h1>
    </header>
    
    <section aria-labelledby="morning-plan-heading">
      <h2 id="morning-plan-heading">‚òÄÔ∏è Morning Plan</h2>
      <div class="input-group">
        <label for="goal">üéØ Today's #1 Goal</label>
        <textarea id="goal" rows="1" placeholder="What is the one thing that will make today a success?"></textarea>
      </div>
      <div class="input-group">
        <label for="tasks">üóìÔ∏è Key Tasks</label>
        <textarea id="tasks" rows="2" placeholder="- Task 1
- Task 2"></textarea>
      </div>
      <div class="input-group">
        <label for="intention">üôè Intention</label>
        <textarea id="intention" rows="1" placeholder="e.g., focused, present, patient"></textarea>
      </div>
    </section>

    <section class="trackers" aria-label="Daily Trackers">
      <div class="tracker-group">
        <label for="mood">Mood</label>
        <select id="mood"><option value="">Select</option><option>‚ö°Ô∏è High Energy</option><option>üòä Good</option><option>üòê Okay</option><option>üìâ Low Energy</option></select>
      </div>
      <div class="tracker-group">
        <label>Habits</label>
        <div class="habit-list">
          <div class="habit"><input type="checkbox" id="habit-meditate"><label for="habit-meditate">Meditate</label></div>
          <div class="habit"><input type="checkbox" id="habit-workout"><label for="habit-workout">Workout</label></div>
          <div class="habit"><input type="checkbox" id="habit-read"><label for="habit-read">Read</label></div>
        </div>
      </div>
    </section>
    
    <section aria-labelledby="evening-review-heading">
      <h2 id="evening-review-heading">üåô Evening Review</h2>
      <div class="input-group">
        <label for="eveningReview">‚úÖ Outcome & Lesson Learned</label>
        <textarea id="eveningReview" rows="3" placeholder="How did the day go? What was the key takeaway?"></textarea>
      </div>
    </section>
    
    <footer>
      <p class="page-number" id="pageNumber"></p>
    </footer>
  </main>

  <div class="controls">
    <button id="prevBtn">‚Äπ Prev</button>
    <button id="nextBtn">Next ‚Ä∫</button>
  </div>
  <div class="controls">
    <button id="downloadBackup">‚¨áÔ∏è Backup</button>
    <input type="file" id="uploadBackup" accept=".json" style="display:none;">
    <button id="loadBackup">‚¨ÜÔ∏è Load Backup</button>
  </div>

<script>
const app = {
  YEAR: 2025,
  TOTAL_DAYS: 365,
  currentDay: 1,
  dom: {},
  config: {},
  
  init() {
    this.TOTAL_DAYS = ((this.YEAR % 4 === 0 && this.YEAR % 100 !== 0) || (this.YEAR % 400 === 0)) ? 366 : 365;
    this.cacheDom();
    this.initConfig(); // Configuration is now much clearer
    this.bindEvents();
    this.loadTheme();
    this.loadInitialPage();
  },
  
  cacheDom() {
    this.dom.dateHeader = document.getElementById('dateHeader');
    this.dom.pageNumber = document.getElementById('pageNumber');
    this.dom.prevBtn = document.getElementById('prevBtn');
    this.dom.nextBtn = document.getElementById('nextBtn');
    this.dom.themeToggle = document.getElementById('themeToggle');
    this.dom.downloadBtn = document.getElementById('downloadBackup');
    this.dom.uploadBtn = document.getElementById('uploadBackup');
    this.dom.loadBtn = document.getElementById('loadBackup');
  },
  
  // --- CHANGE: Updated config to match new, separated fields ---
  initConfig() {
      this.config = {
          // Morning Plan
          goal:          { type: 'value', el: document.getElementById('goal') },
          tasks:         { type: 'value', el: document.getElementById('tasks') },
          intention:     { type: 'value', el: document.getElementById('intention') },
          // Trackers
          mood:          { type: 'value', el: document.getElementById('mood') },
          'habit-meditate': { type: 'checked', el: document.getElementById('habit-meditate') },
          'habit-workout':  { type: 'checked', el: document.getElementById('habit-workout') },
          'habit-read':     { type: 'checked', el: document.getElementById('habit-read') },
          // Evening Review
          eveningReview: { type: 'value', el: document.getElementById('eveningReview') },
      };
  },
  
  bindEvents() {
    this.dom.prevBtn.addEventListener('click', () => this.navigate(-1));
    this.dom.nextBtn.addEventListener('click', () => this.navigate(1));
    this.dom.themeToggle.addEventListener('click', () => this.toggleTheme());
    this.dom.downloadBtn.addEventListener('click', () => this.downloadBackup());
    this.dom.loadBtn.addEventListener('click', () => this.dom.uploadBtn.click());
    this.dom.uploadBtn.addEventListener('change', (e) => this.loadBackup(e));
    
    Object.values(this.config).forEach(field => {
      // Use 'change' for select/checkbox for better performance
      const eventType = (field.el.tagName === 'SELECT' || field.el.type === 'checkbox') ? 'change' : 'input';
      field.el.addEventListener(eventType, () => this.saveState());
    });

    document.querySelectorAll('textarea').forEach(el => {
        el.addEventListener('input', () => this.autoGrow(el));
        // Also run on focus in case content is loaded
        el.addEventListener('focus', () => this.autoGrow(el));
    });
  },
  
  getStorageKey(day, key) { return `journal-v3-${this.YEAR}-day-${day}-${key}`; },
  
  saveState() {
    try {
      for (const [key, field] of Object.entries(this.config)) {
        localStorage.setItem(this.getStorageKey(this.currentDay, key), field.el[field.type]);
      }
      localStorage.setItem('journal-v3-last-opened', this.currentDay);
    } catch (e) { console.error("Failed to save state.", e); }
  },
  
  loadState() {
    for (const [key, field] of Object.entries(this.config)) {
      const value = localStorage.getItem(this.getStorageKey(this.currentDay, key));
      if (value !== null) {
        field.el[field.type] = field.type === 'checked' ? value === 'true' : value;
      } else {
        // Clear fields for new day
        if (field.type === 'checked') {
            field.el.checked = false;
        } else if (field.el.tagName === 'SELECT') {
            field.el.value = '';
        } else {
            field.el.value = '';
        }
      }
    }
  },
  
  updatePage() {
    const date = new Date(this.YEAR, 0, this.currentDay);
    this.dom.dateHeader.textContent = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
    this.dom.pageNumber.textContent = `Day ${this.currentDay} / ${this.TOTAL_DAYS}`;
    this.loadState();
    // Use a timeout to ensure content is loaded before resizing
    setTimeout(() => {
        document.querySelectorAll('textarea').forEach(this.autoGrow);
    }, 0);
    this.dom.prevBtn.disabled = this.currentDay <= 1;
    this.dom.nextBtn.disabled = this.currentDay >= this.TOTAL_DAYS;
  },
  
  navigate(direction) {
    this.saveState();
    const newDay = this.currentDay + direction;
    if (newDay >= 1 && newDay <= this.TOTAL_DAYS) {
      this.currentDay = newDay;
      this.updatePage();
    }
  },
  
  loadInitialPage() {
    const saved = parseInt(localStorage.getItem('journal-v3-last-opened'), 10);
    const today = new Date();
    const start = new Date(this.YEAR, 0, 1);
    const dayOfYear = Math.floor((today - start) / (1000 * 60 * 60 * 24)) + 1;
    
    let initialDay = 1;
    if (today.getFullYear() === this.YEAR) {
        initialDay = dayOfYear;
    }
    // Prefer last opened day unless it's a new year
    this.currentDay = !isNaN(saved) ? saved : initialDay;

    this.updatePage();
  },

  autoGrow(element) {
    element.style.height = 'auto';
    element.style.height = (element.scrollHeight) + 'px';
  },
  
  toggleTheme() {
    const isDark = document.documentElement.hasAttribute('data-theme');
    if (isDark) {
      document.documentElement.removeAttribute('data-theme');
      localStorage.setItem('journal-theme', 'light');
      this.dom.themeToggle.textContent = 'üåô';
    } else {
      document.documentElement.setAttribute('data-theme', 'dark');
      localStorage.setItem('journal-theme', 'dark');
      this.dom.themeToggle.textContent = '‚òÄÔ∏è';
    }
  },
  
  loadTheme() {
    if (localStorage.getItem('journal-theme') === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      this.dom.themeToggle.textContent = '‚òÄÔ∏è';
    } else {
      this.dom.themeToggle.textContent = 'üåô';
    }
  },

  downloadBackup() {
      const data = {};
      for (let i = 1; i <= this.TOTAL_DAYS; i++) {
          const dayData = {};
          let hasData = false;
          for (const key of Object.keys(this.config)) {
              const value = localStorage.getItem(this.getStorageKey(i, key));
              if (value !== null) {
                  dayData[key] = value;
                  hasData = true;
              }
          }
          if (hasData) {
              data[`day-${i}`] = dayData;
          }
      }
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `journal-backup-${this.YEAR}.json`;
      a.click();
      URL.revokeObjectURL(url);
  },

  loadBackup(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
          try {
              const data = JSON.parse(event.target.result);
              if (!confirm('This will overwrite existing data. Are you sure?')) return;
              for (const [dayKey, dayData] of Object.entries(data)) {
                  const day = dayKey.split('-')[1];
                  for (const [fieldKey, value] of Object.entries(dayData)) {
                      localStorage.setItem(this.getStorageKey(day, fieldKey), value);
                  }
              }
              alert('Backup loaded successfully!');
              this.updatePage(); // Refresh current page with loaded data
          } catch (error) {
              alert('Failed to load backup file. It might be corrupted.');
              console.error(error);
          }
      };
      reader.readAsText(file);
  }
};
app.init();
</script>
</body>
</html>