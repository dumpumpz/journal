<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0"/>
  <title>My Journal</title>
  <style>
    /* Layout Lockdown */
    html { box-sizing: border-box; }
    *, *:before, *:after { box-sizing: inherit; }
    html, body { overflow-x: hidden; }

    :root { /* Unchanged */ }
    [data-theme="dark"] { /* Unchanged */ }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Georgia', serif; display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; }
    main { width: 100%; max-width: 600px; background: var(--paper); padding: 25px; border-radius: 8px; box-shadow: 0 4px 20px var(--shadow); display: flex; flex-direction: column; gap: 25px; transition: opacity 0.2s ease-in-out; }
    main.journal-page--loading { opacity: 0; }
    
    /* Other CSS unchanged... */
    .controls { margin-top: 20px; display: flex; gap: 16px; justify-content: center; align-items: center; }
    button { background: var(--accent); color: white; border: none; padding: 10px 20px; font-size: 1em; border-radius: 5px; cursor: pointer; transition: background 0.3s, opacity 0.3s; font-family: sans-serif; }
    
    /* NEW: Settings button style */
    .settings-btn {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-light);
      padding: 8px;
      line-height: 1;
      font-size: 1.2em;
    }
    .settings-btn:hover {
      background: var(--bg);
      color: var(--text);
    }
    
    /* NEW: Settings Menu & Backdrop */
    .settings-backdrop {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .settings-menu {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 300px;
      background: var(--paper);
      padding: 20px;
      border-radius: 8px;
      z-index: 101;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .settings-menu.is-open,
    .settings-backdrop.is-open {
      opacity: 1;
      pointer-events: auto;
    }
    .settings-menu .menu-title {
        margin: 0;
        text-align: center;
        font-family: sans-serif;
    }
    /* Style for buttons inside the menu */
    .settings-menu button {
        width: 100%;
    }
  </style>
</head>
<body>
  <!-- HTML and Main content is unchanged -->
  <button class="theme-toggle" id="themeToggle">‚òÄÔ∏è</button>
  <main id="journalPage"><!-- ... journal content ... --></main>

  <!-- CONTROLS: Now simplified -->
  <div class="controls">
    <button id="prevBtn">‚Äπ Prev</button>
    <button id="nextBtn">Next ‚Ä∫</button>
    <button id="settingsBtn" class="settings-btn" aria-label="Settings">‚öôÔ∏è</button>
  </div>

  <!-- NEW: Settings menu, hidden by default -->
  <div class="settings-backdrop" id="settingsBackdrop"></div>
  <div class="settings-menu" id="settingsMenu">
    <h3 class="menu-title">Data Management</h3>
    <button id="downloadBackup">‚¨áÔ∏è Download Backup</button>
    <button id="loadBackup">‚¨ÜÔ∏è Load from Backup</button>
    <input type="file" id="uploadBackup" accept=".json" style="display:none;">
  </div>
  
  <script>
    const app = {
      // Properties are unchanged...
      init() {
        this.TOTAL_DAYS = ((this.YEAR % 4 === 0 && this.YEAR % 100 !== 0) || (this.YEAR % 400 === 0)) ? 366 : 365;
        this.cacheDom();
        this.initConfig();
        this.bindEvents();
        this.loadTheme();
        this.loadInitialPage();
      },
      
      cacheDom() {
        this.dom = {
          mainPage: document.getElementById('journalPage'),
          dateHeader: document.getElementById('dateHeader'),
          pageNumber: document.getElementById('pageNumber'),
          prevBtn: document.getElementById('prevBtn'),
          nextBtn: document.getElementById('nextBtn'),
          themeToggle: document.getElementById('themeToggle'),
          
          // NEW: Caching menu elements
          settingsBtn: document.getElementById('settingsBtn'),
          settingsMenu: document.getElementById('settingsMenu'),
          settingsBackdrop: document.getElementById('settingsBackdrop'),
          
          // These are now inside the menu, but the logic remains the same
          downloadBtn: document.getElementById('downloadBackup'),
          uploadBtn: document.getElementById('uploadBackup'),
          loadBtn: document.getElementById('loadBackup'),
          
          textareas: document.querySelectorAll('textarea'),
          moodSelectors: document.querySelectorAll('.mood-tracker select'),
        };
      },
      
      initConfig() { /* ... unchanged ... */ },
      
      bindEvents() {
        // Daily navigation
        this.dom.prevBtn.addEventListener('click', () => this.navigate(-1));
        this.dom.nextBtn.addEventListener('click', () => this.navigate(1));
        
        // Data saving listeners (unchanged)
        this.dom.mainPage.addEventListener('input', (e) => { if (e.target.id && this.config[e.target.id]) { this.saveState(); if(e.target.tagName === 'TEXTAREA') this.autoGrow(e.target); } });
        this.dom.mainPage.addEventListener('change', (e) => { if (e.target.tagName === 'SELECT') { this.saveState(); this.updateMoodEmoji(e.target); } });

        // Theme toggle
        this.dom.themeToggle.addEventListener('click', () => this.toggleTheme());
        
        // Backup and Load buttons (their logic is unchanged)
        this.dom.downloadBtn.addEventListener('click', () => this.downloadBackup());
        this.dom.loadBtn.addEventListener('click', () => this.dom.uploadBtn.click());
        this.dom.uploadBtn.addEventListener('change', (e) => this.loadBackup(e));

        // NEW: Settings Menu listeners
        this.dom.settingsBtn.addEventListener('click', () => this.openSettings());
        this.dom.settingsBackdrop.addEventListener('click', () => this.closeSettings());
      },
      
      // NEW: Functions to control the menu
      openSettings() {
        this.dom.settingsMenu.classList.add('is-open');
        this.dom.settingsBackdrop.classList.add('is-open');
      },
      closeSettings() {
        this.dom.settingsMenu.classList.remove('is-open');
        this.dom.settingsBackdrop.classList.remove('is-open');
      },

      // --- All other JS functions are unchanged ---
      getStorageKey(day, key) { /* ... */ },
      saveState() { /* ... */ },
      loadState() { /* ... */ },
      updatePageUI() { /* ... */ },
      navigate(direction) { /* ... */ },
      loadInitialPage() { /* ... */ },
      autoGrow(element) { /* ... */ },
      updateMoodEmoji(selectElement) { /* ... */ },
      toggleTheme() { /* ... */ },
      loadTheme() { /* ... */ },
      downloadBackup() { /* ... */ },
      loadBackup(e) {
          this.loadBackupAndCloseMenu(e); // Close menu after action
      },
      
      // Helper to make UX better
      loadBackupAndCloseMenu(e) {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (!confirm('This will overwrite existing data. Are you sure?')) return;
            for (const [dayKey, dayData] of Object.entries(data)) {
              const day = dayKey.split('-')[1];
              for (const [fieldKey, value] of Object.entries(dayData)) {
                if (this.config[fieldKey]) localStorage.setItem(this.getStorageKey(day, fieldKey), value);
              }
            }
            alert('Backup loaded successfully!');
            this.updatePageUI();
            this.closeSettings(); // <-- Close menu on success
          } catch (error) {
            alert('Failed to load backup file. It might be corrupted.');
            console.error(error);
          }
        };
        reader.readAsText(file);
      }
    };

    // Full JS functions for completeness (they are minimized in the style block for readability)
    app.initConfig = function() { this.config = { dailyLog: { type: 'value', el: document.getElementById('dailyLog') }, goal: { type: 'value', el: document.getElementById('goal') }, eveningNote: { type: 'value', el: document.getElementById('eveningNote') }, morningMood: { type: 'value', el: document.getElementById('morningMood') }, afternoonMood: { type: 'value', el: document.getElementById('afternoonMood') }, eveningMood: { type: 'value', el: document.getElementById('eveningMood') }, }; };
    app.getStorageKey = function(day, key) { return `journal-v5-${this.YEAR}-day-${day}-${key}`; };
    app.saveState = function() { try { for (const [key, field] of Object.entries(this.config)) { localStorage.setItem(this.getStorageKey(this.currentDay, key), field.el[field.type]); } localStorage.setItem('journal-v5-last-opened', this.currentDay); } catch (e) { console.error("Failed to save state.", e); } };
    app.loadState = function() { for (const [key, field] of Object.entries(this.config)) { const value = localStorage.getItem(this.getStorageKey(this.currentDay, key)); field.el[field.type] = value || (field.type === 'checked' ? false : ''); } };
    app.updatePageUI = function() { const date = new Date(this.YEAR, 0, this.currentDay); document.getElementById('dateHeader').textContent = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }); document.getElementById('pageNumber').textContent = `Day ${this.currentDay} / ${this.TOTAL_DAYS}`; this.loadState(); this.dom.textareas.forEach(el => this.autoGrow(el)); this.dom.moodSelectors.forEach(el => this.updateMoodEmoji(el)); this.dom.prevBtn.disabled = this.currentDay <= 1; this.dom.nextBtn.disabled = this.currentDay >= this.TOTAL_DAYS; };
    app.navigate = function(direction) { if ((direction === -1 && this.currentDay <= 1) || (direction === 1 && this.currentDay >= this.TOTAL_DAYS)) { return; } this.saveState(); this.dom.mainPage.classList.add('journal-page--loading'); setTimeout(() => { this.currentDay += direction; this.updatePageUI(); this.dom.mainPage.classList.remove('journal-page--loading'); }, 200); };
    app.loadInitialPage = function() { const saved = parseInt(localStorage.getItem('journal-v5-last-opened'), 10); const today = new Date(); const start = new Date(this.YEAR, 0, 1); const dayOfYear = Math.floor((today - start) / (1000 * 60 * 60 * 24)) + 1; let initialDay = (today.getFullYear() === this.YEAR) ? dayOfYear : 1; this.currentDay = !isNaN(saved) ? saved : initialDay; this.updatePageUI(); };
    app.autoGrow = function(element) { if (!element) return; element.style.height = 'auto'; element.style.height = (element.scrollHeight) + 'px'; };
    app.updateMoodEmoji = function(selectElement) { const emojiSpan = document.getElementById(`${selectElement.id}Emoji`); if (!emojiSpan) return; const selectedOption = selectElement.options[selectElement.selectedIndex]; emojiSpan.textContent = selectedOption.dataset.emoji || ''; };
    app.toggleTheme = function() { const isDark = document.documentElement.hasAttribute('data-theme'); if (isDark) { document.documentElement.removeAttribute('data-theme'); localStorage.setItem('journal-theme', 'light'); this.dom.themeToggle.textContent = 'üåô'; } else { document.documentElement.setAttribute('data-theme', 'dark'); localStorage.setItem('journal-theme', 'dark'); this.dom.themeToggle.textContent = '‚òÄÔ∏è'; } };
    app.loadTheme = function() { if (localStorage.getItem('journal-theme') === 'dark') { document.documentElement.setAttribute('data-theme', 'dark'); this.dom.themeToggle.textContent = '‚òÄÔ∏è'; } else { this.dom.themeToggle.textContent = 'üåô'; } };
    app.downloadBackup = function() { const data = {}; for (let i = 1; i <= this.TOTAL_DAYS; i++) { const dayData = {}; let hasData = false; for (const key of Object.keys(this.config)) { const value = localStorage.getItem(this.getStorageKey(i, key)); if (value !== null && value !== '') { dayData[key] = value; hasData = true; } } if (hasData) { data[`day-${i}`] = dayData; } } const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `journal-backup-${this.YEAR}.json`; a.click(); URL.revokeObjectURL(url); this.closeSettings(); };

    app.init();
  </script>
</body>
</html>